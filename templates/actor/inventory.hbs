{{! Inventory Tab }}
<section
  class="tab inventory {{tab.cssClass}}"
  data-group="primary"
  data-tab="inventory"
>
{{#if (eq actor.type "character")}}

<section class="weapon-loadouts horizontal active-set-{{system.combat.activeWeaponSet}}">

  {{!-- LEFT: SET 1 --}}
  <div class="weapon-set-block">
    <div class="weapon-loadout-label">Set 1</div>

    <div class="weapon-slot-row" data-action="weaponSlot"
     data-slot="{{slot.id}}"
     {{#if slot.itemId}}
     data-item-id="{{slot.itemId}}"
     {{/if}}>


      {{!-- MAIN --}}
      <div
        class="weapon-slot main {{#if weaponSets.1.main}}filled{{else}}empty{{/if}}"
        data-set="1"
        data-slot="main"
        {{#if weaponSets.1.main}}
          data-drag="true"
          data-item-id="{{weaponSets.1.main._id}}"
        {{/if}}
      >
        {{#if weaponSets.1.main}}
          <img src="{{weaponSets.1.main.img}}" title="{{weaponSets.1.main.name}}" />
        {{else}}
          <span>Main</span>
        {{/if}}
      </div>

      {{!-- OFF --}}
<div
  class="weapon-slot off
    {{#if weaponSets.1.mainIsTwoHanded}}blocked{{else}}
      {{#if weaponSets.1.off}}filled{{else}}empty{{/if}}
      {{#if weaponSets.1.offIsShield}}shield{{/if}}
    {{/if}}"
  data-set="1"
  data-slot="off"
  {{#if (and weaponSets.1.off (not weaponSets.1.mainIsTwoHanded))}}
    data-drag="true"
    data-item-id="{{weaponSets.1.off._id}}"
  {{/if}}
>

  {{!-- TWO-HANDED GHOST (THIS WAS MISSING) --}}
  {{#if weaponSets.1.mainIsTwoHanded}}
    <div class="two-handed-ghost">
      <img
        src="{{weaponSets.1.main.img}}"
        title="{{weaponSets.1.main.name}} (Two-handed)"
        width="44"
        height="44"
      />
    </div>

  {{!-- SHIELD --}}
  {{else if weaponSets.1.offIsShield}}
    <img
      src="{{weaponSets.1.off.img}}"
      title="{{weaponSets.1.off.name}}"
      width="44"
      height="44"
    />

  {{!-- NORMAL OFF-HAND WEAPON --}}
  {{else if weaponSets.1.off}}
    <img
      src="{{weaponSets.1.off.img}}"
      title="{{weaponSets.1.off.name}}"
      width="44"
      height="44"
    />

  {{!-- EMPTY --}}
  {{else}}
    <span>Off</span>
  {{/if}}

</div>

    </div>
  </div>

  {{!-- CENTER: SWITCH --}}
  <div class="weapon-set-switcher">
<button
  type="button"
  class="weapon-set-toggle {{#if (eq system.combat.activeWeaponSet 2)}}set-2{{else}}set-1{{/if}}"
  data-action="setActiveWeaponSet"
  title="Switch Weapon Set"
>
  <i class="fa-sharp fa-regular fa-arrows-repeat" style="color: #FFD43B;"></i>
</button>
  </div>

  {{!-- RIGHT: SET 2 --}}
  <div class="weapon-set-block">
    <div class="weapon-loadout-label">Set 2</div>

    <div class="weapon-slot-row" data-action="weaponSlot"
     data-slot="{{slot.id}}"
     {{#if slot.itemId}}
     data-item-id="{{slot.itemId}}"
     {{/if}}>


      {{!-- MAIN --}}
      <div
        class="weapon-slot main {{#if weaponSets.2.main}}filled{{else}}empty{{/if}}"
        data-set="2"
        data-slot="main"
        {{#if weaponSets.2.main}}
          data-drag="true"
          data-item-id="{{weaponSets.2.main._id}}"
        {{/if}}
      >
        {{#if weaponSets.2.main}}
          <img src="{{weaponSets.2.main.img}}" title="{{weaponSets.2.main.name}}" />
        {{else}}
          <span>Main</span>
        {{/if}}
      </div>

      {{!-- OFF --}}
<div
  class="weapon-slot off
    {{#if weaponSets.2.mainIsTwoHanded}}blocked{{else}}
      {{#if weaponSets.2.off}}filled{{else}}empty{{/if}}
      {{#if weaponSets.2.offIsShield}}shield{{/if}}
    {{/if}}"
  data-set="2"
  data-slot="off"
  {{#if (and weaponSets.2.off (not weaponSets.2.mainIsTwoHanded))}}
    data-drag="true"
    data-item-id="{{weaponSets.2.off._id}}"
  {{/if}}
>

  {{!-- TWO-HANDED GHOST (THIS WAS MISSING) --}}
  {{#if weaponSets.2.mainIsTwoHanded}}
    <div class="two-handed-ghost">
      <img
        src="{{weaponSets.2.main.img}}"
        title="{{weaponSets.2.main.name}} (Two-handed)"
        width="44"
        height="44"
      />
    </div>

  {{!-- SHIELD --}}
  {{else if weaponSets.2.offIsShield}}
    <img
      src="{{weaponSets.2.off.img}}"
      title="{{weaponSets.2.off.name}}"
      width="44"
      height="44"
    />

  {{!-- NORMAL OFF-HAND WEAPON --}}
  {{else if weaponSets.2.off}}
    <img
      src="{{weaponSets.2.off.img}}"
      title="{{weaponSets.2.off.name}}"
      width="44"
      height="44"
    />

  {{!-- EMPTY --}}
  {{else}}
    <span>Off</span>
  {{/if}}

</div>

    </div>
  </div>

</section>

{{/if}}




 <ol class="items-list inventory-gear">
  <li class="item flexrow items-header">
    <div class="item-name">{{localize "Gear"}}</div>
    <div class="item-formula">
      {{localize "TOS.Item.Weapon.FIELDS.rollFormula.label"}}
    </div>
    <div class="item-controls">
      {{#if @root.editable}}
        <a
          class="item-control item-create"
          data-action="createDoc"
          data-document-class="Item"
          data-type="weapon"
        >
          <i class="fas fa-plus"></i>
        </a>
      {{/if}}
    </div>
  </li>

    {{#each gear as |item id|}}
      <li
   class="item flexrow
    {{#if (and
      item.system.shield
      (eq item._id @root.weaponSets.1.off._id)
    )}}equipped-set-1{{/if}}

    {{#if (and
      item.system.shield
      (eq item._id @root.weaponSets.2.off._id)
    )}}equipped-set-2{{/if}}
  "
        data-item-id="{{item._id}}"
        data-drag="true"
        data-document-class="Item">
        
        <div class="item-name">
          <div class="item-image">
            <a
            class="rollable {{#if item.system.shield}}weapon-icon{{/if}}"
            data-roll-type="item"
            data-action="roll"
            data-item-id="{{item._id}}"
               >
              <img src="{{item.img}}" title="{{item.name}}" width="24" height="24" />
            </a>
          </div>
          <div>{{item.name}}</div>
        </div>
          <!-- Equipped Checkbox (Editable) -->
        {{#unless (and item.system.shield (eq actor.type "character") )}}
          <div class="item-formula item-prop">
            <input type="checkbox" class="item-toggle-equipped"
            data-action="toggleEquipped"
                   data-item-id="{{item._id}}"
                   {{#if item.system.equipped}}checked{{/if}} />
          </div>
        {{/unless}}

        <!-- Layer Value -->
        <div class="item-formula item-prop">
          {{item.system.layer}}
        </div>

        <!-- Armor Value -->
        <div class="item-formula item-prop">
          {{item.system.armor.value}}
        </div>

        <div class="item-controls">
          <a class="item-control item-edit"
            title="{{localize 'DOCUMENT.Update' type="Gear"}}"
            data-action="viewDoc">
            <i class="fas fa-edit"></i>
          </a>
          {{#if @root.editable}}
            <a class="item-control item-delete"
              title="{{localize 'DOCUMENT.Delete' type="Gear"}}"
              data-action="deleteDoc">
              <i class="fas fa-trash"></i>
            </a>
          {{/if}}
        </div>
      </li>
    {{/each}}
</ol>


 <br>
<ol class="items-list inventory-weapons">
  <li class="item flexrow items-header">
    <div class="item-name">{{localize "Weapon"}}</div>
    <div class="item-formula">
      {{localize "TOS.Item.Weapon.FIELDS.rollFormula.label"}}
    </div>
    <div class="item-controls">
      {{#if @root.editable}}
        <a
          class="item-control item-create"
          data-action="createDoc"
          data-document-class="Item"
          data-type="weapon"
        >
          <i class="fas fa-plus"></i>
        </a>
      {{/if}}
    </div>
  </li>

  {{#each weapon as |item|}}

<li
  class="item flexrow
    {{#if (and
      (eq actor.type "character")
      (or
        (eq item._id @root.weaponSets.1.main._id)
        (eq item._id @root.weaponSets.1.off._id)
      )
    )}}equipped-set-1{{/if}}

    {{#if (and
      (eq actor.type "character")
      (or
        (eq item._id @root.weaponSets.2.main._id)
        (eq item._id @root.weaponSets.2.off._id)
      )
    )}}equipped-set-2{{/if}}
  "
    data-item-id="{{item._id}}"
  data-document-class="Item"
  data-drag="true"
>
  <div class="item-name">
        <div class="item-image">
<a
  class="rollable weapon-icon"
  data-roll-type="item"
  data-action="roll"
  data-item-id="{{item._id}}"
>
  <img src="{{item.img}}" title="{{item.name}}" width="24" height="24" />
</a>

        </div>

        <div>
          {{item.name}}
{{#if (eq actor.type "character")}}
          {{#if (and (eq system.combat.activeWeaponSet 1) (eq item._id @root.weaponSets.1.main._id))}}
            <span class="equip-tag">(Main)</span>
          {{/if}}

          {{#if (and (eq system.combat.activeWeaponSet 1) (eq item._id @root.weaponSets.1.off._id))}}
            <span class="equip-tag">(Off)</span>
          {{/if}}

          {{#if (and (eq system.combat.activeWeaponSet 2) (eq item._id @root.weaponSets.2.main._id))}}
            <span class="equip-tag">(Main)</span>
          {{/if}}

          {{#if (and (eq system.combat.activeWeaponSet 2) (eq item._id @root.weaponSets.2.off._id))}}
            <span class="equip-tag">(Off)</span>
          {{/if}}
{{/if}}          
        </div>

      </div>
{{#if item.system.twoHandGrip}}
  <i
    class="grip-toggle fa-duotone fa-solid fa-hands
      {{#if (eq item.system.gripMode "two")}}active{{/if}}"
    data-action="toggleTwoHandGrip"
    data-item-id="{{item._id}}"
    title="Toggle two-handed grip"
  ></i>
{{/if}}


      <div class="item-formula item-prop">
        {{item.system.formula}}
      </div>

      <div class="item-controls">
        <a class="item-control item-edit" data-action="viewDoc">
          <i class="fas fa-edit"></i>
        </a>
        {{#if @root.editable}}
          <a class="item-control item-delete" data-action="deleteDoc">
            <i class="fas fa-trash"></i>
          </a>
        {{/if}}
      </div>
    </li>
  {{/each}}
</ol>



 <br>

   <ol class="items-list inventory-consumable">
    <li class="item flexrow items-header">
      <div class="item-name">{{localize "Consumable"}}</div>

      <div class="item-formula">{{localize
          "TOS.Item.Weapon.FIELDS.rollFormula.label"
        }}</div>
      <div class="item-quantity">{{localize "TOS.Item.Consumable.FIELDS.quantity.label"}}</div>
      <div class="item-controls">
        {{#if @root.editable}}
          <a
            class="item-control item-create"
            title="{{localize 'DOCUMENT.Create' type="Item"}}"
            data-action="createDoc"
            data-document-class="Item"
            data-type="consumable"
          >
            <i class="fas fa-plus"></i>
            {{localize "DOCUMENT.New" type="item"}}
          </a>
        {{/if}}
      </div>
        </li>
 
    {{#each consumables as |item id|}}
      <li
        class="item flexrow"
        data-item-id="{{item._id}}"
        data-drag="true"
        data-document-class="Item"
      >
        <div class="item-name">
          <div class="item-image">
            <a class="rollable" data-roll-type="item" data-action="roll">
              <img
                src="{{item.img}}"
                title="{{item.name}}"
                width="24"
                height="24"
              />
            </a>
          </div>
          <div>{{item.name}}</div>
        </div>
        
        <div class="item-formula item-prop">{{item.system.formula}}</div>
     <div class="item-formula item-prop">
          {{item.system.quantity}}
        </div>
        <div class="item-controls">
                    <a
            class="item-control item-edit"
            title="{{localize 'DOCUMENT.Update' type="Add"}}"
            data-action="addConsumable"
          >
            <i class="fa-solid fa-plus"></i>
          </a>
                    <a
            class="item-control item-edit"
            title="{{localize 'DOCUMENT.Update' type="Subtract"}}"
            data-action="subtractConsumable"
          >
            <i class="fa-solid fa-minus"></i>
          </a>
          <a
            class="item-control item-edit"
            title="{{localize 'DOCUMENT.Update' type="Consumable"}}"
            data-action="viewDoc"
          >
            <i class="fas fa-edit"></i>
          </a>
          {{#if @root.editable}}
            <a
              class="item-control item-delete"
              title="{{localize 'DOCUMENT.Delete' type="Consumable"}}"
              data-action="deleteDoc"
            >
              <i class="fas fa-trash"></i>
            </a>
          {{/if}}
        </div>
      </li>
    {{/each}}
  </ol>


 <br>

   <ol class="items-list inventory-items">
    <li class="item flexrow items-header">
      <div class="item-name">{{localize "Items"}}</div>
      <div class="item-formula">{{localize
          "TOS.Item.Weapon.FIELDS.rollFormula.label"
        }}</div>
      <div class="item-controls">
        {{#if @root.editable}}
          <a
            class="item-control item-create"
            title="{{localize 'DOCUMENT.Create' type="Item"}}"
            data-action="createDoc"
            data-document-class="Item"
            data-type="consumable"
          >
            <i class="fas fa-plus"></i>
            {{localize "DOCUMENT.New" type="item"}}
          </a>
        {{/if}}
      </div>
        </li>
 
    {{#each items as |item id|}}
      <li
        class="item flexrow"
        data-item-id="{{item._id}}"
        data-drag="true"
        data-document-class="Item"
      >
        <div class="item-name">
          <div class="item-image">
            <a class="rollable" data-roll-type="item" data-action="roll">
              <img
                src="{{item.img}}"
                title="{{item.name}}"
                width="24"
                height="24"
              />
            </a>
          </div>
          <div>{{item.name}}</div>
        </div>
        <div class="item-formula item-prop">{{item.system.formula}}</div>
        <div class="item-controls">
          <a
            class="item-control item-edit"
            title="{{localize 'DOCUMENT.Update' type="Item"}}"
            data-action="viewDoc"
          >
            <i class="fas fa-edit"></i>
          </a>
          {{#if @root.editable}}
            <a
              class="item-control item-delete"
              title="{{localize 'DOCUMENT.Delete' type="Item"}}"
              data-action="deleteDoc"
            >
              <i class="fas fa-trash"></i>
            </a>
          {{/if}}
        </div>
      </li>
    {{/each}}
  </ol>
</section>